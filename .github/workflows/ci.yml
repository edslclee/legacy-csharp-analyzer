name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build_test:
    name: Build & Test (web+api)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 루트 설치(모노레포 루트에 devDeps 있는 경우)
      - name: Install root deps
        run: npm ci

      # 웹 설치 & 빌드 (Vite)
      - name: Install web deps
        run: npm --prefix apps/web ci
      - name: Build web
        run: npm --prefix apps/web run build

      # API 설치 & 타입체크 (tsc)
      - name: Install api deps
        run: npm --prefix apps/api ci
      - name: TypeCheck api
        run: npx tsc -p apps/api/tsconfig.json --noEmit

      # (선택) 산출물 업로드
      - name: Upload web dist
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
          if-no-files-found: ignore
